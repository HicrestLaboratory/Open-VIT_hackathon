#include "../include/vision_transformer.h"
#include "../include/utils.h"

#include <iostream>

using namespace std;

int main() {
    cout << "Test VIT" << endl;

    VisionTransformer vit_1;
    load_cvit("../test_files/test_vit_1.cvit", vit_1);
    VisionTransformer vit_2;
    load_cvit("../test_files/test_vit_2.cvit", vit_2);
    VisionTransformer vit_3;
    load_cvit("../test_files/test_vit_3.cvit", vit_3);

    vit_float pic_data[2*3*12*12] = {
         0.851,   0.029,   0.295,  -0.427,  -0.986,  -0.811,   0.780,  -0.634,   0.040,   0.572,  -0.081,   0.222,
         0.733,   0.774,   0.949,  -0.524,  -0.946,  -0.922,  -0.503,  -0.286,  -0.056,   0.032,   0.442,  -0.006,
         0.906,   0.859,   0.478,   0.590,  -0.483,   0.030,  -0.577,   0.894,   0.702,  -0.496,   0.833,  -0.642,
         0.766,  -0.740,  -0.554,   0.078,   0.335,   0.226,  -0.974,   0.836,  -0.853,  -0.540,   0.805,   0.391,
        -0.715,  -0.354,  -0.241,  -0.700,  -0.550,  -0.583,   0.620,  -0.964,  -0.072,  -0.103,   0.335,  -0.340,
         0.888,   0.627,  -0.340,   0.204,  -0.845,   0.187,   0.872,  -0.309,   0.748,  -0.278,  -0.049,   0.226,
         0.114,  -0.718,   0.779,  -0.026,   0.988,   0.449,   0.035,  -0.290,  -0.285,   0.612,  -0.748,  -0.188,
         0.785,  -0.821,  -0.926,   0.264,  -0.081,  -0.865,  -0.065,  -0.679,  -0.654,   0.812,   0.342,  -0.386,
         0.134,  -0.906,   0.360,   0.332,   0.860,   0.330,   0.871,  -0.745,  -0.882,  -0.540,  -0.376,  -0.142,
         0.809,   0.394,   0.822,  -0.243,  -0.004,   0.167,   0.725,  -0.910,  -0.573,   0.252,   0.253,  -0.021,
        -0.194,  -0.410,   0.510,  -0.441,   0.301,   0.069,  -0.157,  -0.230,  -0.921,   0.257,   0.308,  -0.897,
         0.063,   0.610,   0.520,  -0.344,  -0.987,  -0.655,   0.566,  -0.029,  -0.482,  -0.230,  -0.525,   0.050,

        -0.276,   0.081,  -0.738,  -0.338,  -0.491,  -0.341,  -0.131,  -0.458,   0.790,  -0.181,  -0.109,  -0.489,
         0.957,   0.220,  -0.507,  -0.064,   0.091,  -0.696,  -0.904,  -0.282,   0.831,  -0.213,   0.984,  -0.790,
         0.167,   0.918,   0.974,  -0.377,   0.309,  -0.769,   0.779,  -0.225,   0.538,  -0.059,  -0.866,  -0.249,
        -0.107,   0.829,  -0.115,  -0.490,  -0.953,  -0.763,  -0.679,   0.467,  -0.177,   0.894,  -0.286,  -0.104,
         0.847,   0.507,   0.682,   0.924,   0.530,   0.641,   0.062,  -0.436,   0.613,  -0.505,   0.528,   0.160,
         0.018,  -0.983,   0.107,  -0.754,   0.402,   0.140,   0.751,  -0.095,   0.122,   0.554,   0.550,   0.620,
         0.731,   0.063,  -0.674,  -0.319,  -0.970,  -0.188,   0.301,  -0.117,   0.306,   0.744,   0.428,  -0.185,
        -0.613,   0.979,   0.851,   0.498,   0.253,   0.744,  -0.407,   0.716,   0.847,  -0.157,  -0.944,  -0.408,
        -0.990,  -0.017,   0.230,   0.457,  -0.314,   0.192,   0.571,   0.231,   0.827,  -0.411,   0.102,   0.474,
         0.661,   0.053,  -0.485,   0.459,  -0.018,   0.882,   0.656,  -0.306,  -0.760,  -0.479,   0.327,   0.259,
        -0.977,   0.857,   0.637,  -0.598,  -0.935,  -0.400,  -0.464,   0.654,  -0.202,  -0.956,   0.797,   0.147,
         0.634,  -0.621,  -0.967,  -0.815,  -0.103,  -0.827,  -0.752,   0.404,  -0.706,  -0.132,   0.774,  -0.256,

         0.249,   0.039,   0.206,  -0.753,  -0.348,   0.252,   0.898,  -0.199,  -0.238,   0.782,   0.980,   0.733,
         0.367,  -0.237,  -0.463,  -0.342,   0.989,   0.784,  -0.546,   0.901,  -0.480,  -0.779,   0.754,  -0.403,
         0.372,  -0.104,   0.577,  -0.463,   0.177,  -0.178,   0.370,   0.067,   0.475,   0.796,   0.795,   0.715,
         0.771,   0.636,  -0.459,   0.334,  -0.206,   0.010,   0.076,  -0.315,  -0.815,   0.316,   0.562,  -0.010,
         0.219,  -0.203,  -0.661,   0.125,  -0.105,   0.701,   0.158,  -0.649,   0.879,  -0.284,  -0.287,   0.400,
         0.575,  -0.908,   0.944,   0.839,   0.446,  -0.855,   0.443,  -0.824,   0.731,  -0.058,   0.444,   0.689,
         0.666,  -0.224,   0.521,   0.883,  -0.849,   0.024,   0.602,   0.842,   0.162,  -0.187,  -0.687,   0.842,
        -0.897,  -0.005,   0.236,   0.129,  -0.182,  -0.405,   0.393,  -0.525,  -0.301,   0.755,   0.327,  -0.275,
         0.143,   0.270,  -0.263,   0.070,   0.116,  -0.627,  -0.666,   0.607,  -0.194,  -0.666,   0.041,   0.407,
        -0.017,   0.743,   0.020,   0.578,   0.626,   0.792,  -0.669,   0.011,  -0.980,   0.883,   0.559,  -0.198,
        -0.069,   0.384,  -0.657,   0.026,  -0.145,   0.765,   0.701,  -0.399,  -0.142,  -0.385,   0.740,   0.965,
         0.994,   0.762,   0.176,   0.022,  -0.272,  -0.026,   0.498,   0.316,  -0.718,   0.507,  -0.178,   0.682,



        -0.349,  -0.449,   0.686,  -0.191,  -0.767,  -0.472,  -0.198,   0.588,   0.558,   0.963,   0.917,   0.309,
         0.624,  -0.480,   0.675,   0.706,   0.579,  -0.517,   0.844,  -0.523,   0.949,   0.864,  -0.005,   0.959,
         0.443,  -0.665,   0.699,  -0.065,   0.100,   0.389,  -0.839,   0.074,  -0.082,  -0.190,  -0.750,  -0.535,
         0.736,  -0.953,  -0.035,  -0.831,  -0.367,  -0.955,   0.850,  -0.343,   0.358,  -0.436,   0.253,  -0.573,
         0.526,   0.060,   0.802,   0.570,   0.096,  -0.471,  -0.446,  -0.812,  -0.076,   0.330,  -0.285,   0.186,
         0.347,   0.577,   0.559,   0.952,   0.783,  -0.905,   0.242,   0.467,  -0.640,   0.542,  -0.922,   0.886,
         0.095,  -0.480,  -0.993,  -0.028,  -0.127,   0.438,   0.626,   0.024,  -0.805,   0.114,  -0.195,  -0.949,
         0.855,   0.919,  -0.712,  -0.526,  -0.839,   0.864,  -0.315,  -0.553,  -0.297,  -0.273,   0.500,  -0.753,
         0.928,   0.431,   0.539,   0.765,   0.550,   0.355,  -0.718,   0.747,   0.874,   0.133,  -0.397,   0.060,
         0.272,  -0.914,  -0.395,   0.305,   0.567,   0.745,   0.328,   0.905,   0.261,   0.223,   0.757,  -0.911,
        -0.848,  -0.984,   0.531,  -0.611,  -0.620,  -0.912,  -0.322,   0.739,   0.014,  -0.362,   0.116,  -0.686,
        -0.241,  -0.023,   0.273,  -0.251,   0.817,  -0.940,  -0.102,  -0.825,   0.917,  -0.380,   0.554,  -0.588,

        -0.027,  -0.426,  -0.223,   0.676,   0.160,   0.316,   0.505,  -0.644,   0.371,  -0.695,   0.682,  -0.404,
        -0.690,   0.673,   0.297,   0.674,  -0.638,   0.669,  -0.587,  -0.880,  -0.838,  -0.713,   0.928,   0.420,
        -0.209,   0.113,  -0.771,   0.827,  -0.394,  -0.561,  -0.450,   0.658,  -0.458,   0.353,   0.613,   0.398,
        -0.654,  -0.330,   0.294,  -0.092,  -0.847,  -0.657,   0.172,  -0.579,   0.110,   0.094,   0.665,  -0.717,
         0.940,   0.874,  -0.729,   0.557,   0.344,   0.358,   0.620,  -0.557,   0.884,   0.856,  -0.088,  -0.240,
         0.899,   0.473,   0.921,  -0.240,  -0.170,  -0.379,  -0.959,  -0.689,   0.247,   0.092,   0.551,  -0.285,
         0.744,   0.957,  -0.856,  -0.739,   0.366,   0.049,   0.411,   0.947,   0.395,   0.316,  -0.441,   0.352,
         0.417,  -0.873,  -0.677,   0.692,   0.562,   0.035,  -0.885,   0.803,   0.964,  -0.494,   0.515,   0.577,
        -0.041,   0.254,   0.473,  -0.373,  -0.513,   0.452,  -0.827,   0.595,  -0.523,  -0.698,   0.078,   0.929,
        -0.718,  -0.726,  -0.804,   0.820,   0.186,  -0.378,  -0.427,  -0.680,  -0.541,  -0.567,  -0.702,   0.863,
         0.653,  -0.563,  -0.893,  -0.612,   0.604,  -0.808,  -0.052,  -0.022,   0.329,  -0.342,   0.541,   0.703,
        -0.808,   0.908,  -0.091,  -0.507,  -0.362,  -0.039,   0.208,  -0.699,   0.302,   0.617,   0.686,   0.999,

         0.931,   0.914,   0.203,  -0.242,  -0.170,   0.852,   0.433,   0.769,   0.639,  -0.783,  -0.909,   0.082,
         0.572,   0.400,  -0.167,  -0.288,   0.251,   0.672,  -0.710,  -0.157,   0.325,  -0.624,   0.747,   0.892,
         0.062,  -0.837,   0.826,  -0.416,   0.764,  -0.162,   0.620,  -0.262,   0.222,   0.538,  -0.922,   0.098,
         0.823,   0.723,   0.402,  -0.199,   0.393,  -0.188,   0.398,   0.923,  -0.304,   0.877,   0.131,  -0.340,
        -0.642,  -0.191,  -0.279,   0.305,   0.188,  -0.085,   0.527,  -0.185,  -0.725,   0.017,   0.341,  -0.102,
        -0.883,   0.077,   0.556,  -0.162,   0.373,  -0.642,  -0.799,  -0.330,  -0.958,  -0.534,  -0.254,   0.307,
         0.472,   0.952,   0.560,  -0.012,  -0.396,   0.817,  -0.661,   0.150,  -0.227,  -0.976,  -0.068,   0.661,
         0.927,   0.201,  -0.069,   0.336,  -0.427,   0.427,  -0.236,   0.938,   0.446,   0.927,   0.205,  -0.578,
         0.244,  -0.070,  -0.550,   0.192,   0.159,   0.026,  -0.457,  -0.366,   0.598,   0.577,   0.290,  -0.531,
        -0.642,   0.186,  -0.147,   0.183,   0.007,   0.188,   0.498,  -0.286,   0.055,   0.971,  -0.779,  -0.754,
         0.033,   0.608,   0.847,   0.210,  -0.503,  -0.675,  -0.640,  -0.656,  -0.532,   0.631,   0.917,  -0.988,
        -0.282,   0.205,  -0.116,   0.814,   0.391,   0.213,   0.847,  -0.394,   0.074,   0.011,   0.515,  -0.935
    };
    PictureBatch pic(pic_data, 2*3*12*12, 2, 3, 12, 12);
    cout << "### pic" << endl;
    pic.print();

    Tensor features_1;
    vit_1.forward_features(pic, features_1);
    cout << "### features_1" << endl;
    features_1.print();
    PredictionBatch pred_1;
    vit_1.forward(pic, pred_1);
    cout << "### pred_1" << endl;
    pred_1.print();

    Tensor features_2;
    vit_2.forward_features(pic, features_2);
    cout << "### features_2" << endl;
    features_2.print();
    PredictionBatch pred_2;
    vit_2.forward(pic, pred_2);
    cout << "### pred_2" << endl;
    pred_2.print();

    Tensor features_3;
    vit_3.forward_features(pic, features_3);
    cout << "### features_3" << endl;
    features_3.print();
    PredictionBatch pred_3;
    vit_3.forward(pic, pred_3);
    cout << "### pred_3" << endl;
    pred_3.print();

    return 0;
}
